<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sungwoo Stamping Pvt Ltd</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
:root {
  --bg:#f0f5f9; --bg2:#e4edf5; --surface:#ffffff; --surface2:#eef3f8;
  --border:#c8d9e8; --border2:#a8c4d8;
  --accent:#0099bb; --accent2:#e07b10; --accent3:#00a882;
  --warn:#d97706; --text:#1a2e3d; --text2:#2e5068; --muted:#6a8fa8;
  --danger:#e02050; --success:#00a882;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse 80% 60% at 10% 0%,rgba(0,153,187,.07) 0%,transparent 60%),linear-gradient(160deg,#f0f5f9 0%,#e8f0f8 40%,#edf3f8 100%);pointer-events:none;}
body::after{content:'';position:fixed;inset:0;z-index:0;background-image:radial-gradient(circle,rgba(0,120,160,.06) 1px,transparent 1px);background-size:32px 32px;pointer-events:none;}

/* ===== PAGES ===== */
.page{display:none;min-height:100vh;position:relative;z-index:1;}
.page.active{display:flex;flex-direction:column;}

/* ===== LOGIN ===== */
#loginPage{align-items:center;justify-content:center;padding:24px;}
.login-card{width:100%;max-width:430px;border-radius:24px;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.5),0 0 0 1px rgba(0,120,160,.1);animation:riseIn .6s cubic-bezier(.22,1,.36,1);}
@keyframes riseIn{from{opacity:0;transform:translateY(40px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.login-header{background:linear-gradient(135deg,#0077a0 0%,#005580 50%,#003f60 100%);padding:44px 40px 32px;text-align:center;position:relative;overflow:hidden;border-bottom:1px solid rgba(0,153,187,.2);}
.login-header::before{content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,rgba(0,212,240,.18) 0%,transparent 70%);}
.login-logo-icon{width:68px;height:68px;background:linear-gradient(135deg,#0099bb,#007899);border-radius:18px;display:inline-flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:700;color:#ffffff;letter-spacing:1px;margin-bottom:16px;box-shadow:0 8px 32px rgba(0,153,187,.35);}
.login-company{font-size:1.7rem;font-weight:700;letter-spacing:3px;color:#fff;text-transform:uppercase;}
.login-company span{color:var(--accent);}
.login-sub{font-family:'Space Mono',monospace;font-size:.6rem;color:rgba(180,220,240,.7);letter-spacing:2.5px;text-transform:uppercase;margin-top:6px;}
.login-body{padding:32px 40px;background:var(--surface);}
.login-title{font-size:1rem;font-weight:600;letter-spacing:1px;color:var(--text2);margin-bottom:22px;text-align:center;text-transform:uppercase;}
.form-group{margin-bottom:14px;}
label{display:block;font-size:.67rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:7px;font-family:'Space Mono',monospace;}
input,select,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;transition:border-color .2s,box-shadow .2s;outline:none;}
input::placeholder,textarea::placeholder{color:var(--muted);opacity:.6;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,240,.12);}
select option{background:var(--surface2);color:var(--text);}
textarea{resize:vertical;min-height:60px;}
.role-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px;}
.role-tab{padding:11px;border:1px solid var(--border);border-radius:10px;background:var(--surface2);color:var(--muted);font-family:'Space Mono',monospace;font-size:.75rem;cursor:pointer;text-align:center;transition:all .2s;}
.role-tab.active{border-color:var(--accent);color:var(--accent);background:rgba(0,153,187,.08);}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all .22s;text-transform:uppercase;}
.btn-primary{background:linear-gradient(135deg,#0099bb,#007799);color:#ffffff;box-shadow:0 4px 20px rgba(0,153,187,.3);}
.btn-primary:hover{background:linear-gradient(135deg,#00aacc,#0088aa);transform:translateY(-1px);box-shadow:0 8px 28px rgba(0,153,187,.4);}
.btn-sm{width:auto;padding:8px 16px;font-size:.78rem;border-radius:8px;letter-spacing:.5px;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,153,187,.07);}
.btn-success{background:linear-gradient(135deg,#00a882,#008866);color:#ffffff;}
.btn-success:hover{background:linear-gradient(135deg,#00bb99,#009977);}
.btn-warn{background:linear-gradient(135deg,#e07b10,#c06000);color:#ffffff;}
.btn-warn:hover{background:linear-gradient(135deg,#f5921a,#d47010);}
.login-error{background:rgba(255,92,122,.1);border:1px solid rgba(255,92,122,.3);border-radius:10px;padding:10px 14px;font-family:'Space Mono',monospace;font-size:.74rem;color:var(--danger);margin-top:12px;display:none;}
.login-hint{text-align:center;font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:20px;line-height:2;opacity:.75;}

/* ===== HEADER ===== */
header{border-bottom:1px solid rgba(0,120,160,.12);padding:13px 0;position:sticky;top:0;background:rgba(240,245,249,.96);backdrop-filter:blur(16px);z-index:100;}
.header-inner{display:flex;align-items:center;justify-content:space-between;max-width:1600px;margin:0 auto;padding:0 24px;}
.company-logo{display:flex;align-items:center;gap:12px;}
.company-logo-icon{filter:drop-shadow(0 2px 12px rgba(0,212,240,.35));}
.company-name{font-size:1.3rem;font-weight:700;letter-spacing:2px;color:var(--text);text-transform:uppercase;}
.company-name span{color:var(--accent);}
.company-tagline{font-family:'Space Mono',monospace;font-size:.55rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:3px;}
.nav-links{display:flex;align-items:center;gap:5px;}
.nav-btn{padding:7px 16px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--muted);}
.nav-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,153,187,.07);}
.nav-btn.active{background:rgba(0,153,187,.08);border-color:var(--accent);color:var(--accent);}
.nav-btn.logout{border-color:rgba(255,92,122,.3);color:var(--danger);}
.nav-btn.logout:hover{background:rgba(255,92,122,.08);border-color:var(--danger);}
.header-right{display:flex;align-items:center;gap:12px;}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:5px 14px 5px 5px;font-size:.8rem;font-weight:500;color:var(--text2);}
.user-avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#0099bb,#007799);color:#ffffff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.7rem;}
.live-badge{display:inline-flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.6rem;color:var(--accent3);letter-spacing:1px;}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--accent3);animation:pulse 2s infinite;display:inline-block;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.header-clock{font-family:'Space Mono',monospace;font-size:.62rem;color:var(--muted);}

/* ===== LAYOUT ===== */
.container{max-width:1600px;margin:0 auto;padding:0 24px;position:relative;z-index:1;}
main{padding:28px 0;}

/* ===== STAT CARDS ===== */
.summary-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-bottom:28px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0;}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.25);}
.stat-card.c1::before{background:linear-gradient(90deg,var(--accent),var(--accent3));}
.stat-card.c2::before{background:linear-gradient(90deg,#5b8def,var(--accent));}
.stat-card.c3::before{background:linear-gradient(90deg,var(--accent3),#00c9a7);}
.stat-card.c4::before{background:linear-gradient(90deg,var(--accent2),#f87171);}
.stat-card.c5::before{background:linear-gradient(90deg,#a78bfa,#7c3aed);}
.stat-card.c6::before{background:linear-gradient(90deg,#f87171,var(--danger));}
.stat-label{font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;font-family:'Space Mono',monospace;}
.stat-value{font-size:2rem;font-weight:700;line-height:1;}
.stat-card.c1 .stat-value{color:var(--accent);}
.stat-card.c2 .stat-value{color:#5b9def;}
.stat-card.c3 .stat-value{color:var(--accent3);}
.stat-card.c4 .stat-value{color:var(--accent2);}
.stat-card.c5 .stat-value{color:#a78bfa;}
.stat-card.c6 .stat-value{color:var(--danger);}

/* ===== PANELS ===== */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.18);}
.panel-header{padding:16px 22px;border-bottom:1px solid rgba(0,212,240,.1);display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(0,153,187,.03);}
.panel-header-left{display:flex;align-items:center;gap:10px;}
.panel-title{font-size:.88rem;font-weight:600;letter-spacing:1px;color:var(--text);text-transform:uppercase;}
.panel-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}
.panel-icon.cyan{background:rgba(0,212,240,.12);}
.panel-icon.teal{background:rgba(61,232,197,.12);}
.panel-icon.amber{background:rgba(245,166,35,.12);}
.panel-icon.purple{background:rgba(130,100,255,.12);}
.panel-icon.red{background:rgba(255,92,122,.12);}
.panel-body{padding:22px;}

/* ===== FORM GRID ===== */
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px;}
.form-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.form-grid-full{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:14px;}
.fg{margin-bottom:0;}

/* ===== TABLE ===== */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{font-family:'Space Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);padding:10px 13px;text-align:left;border-bottom:1px solid rgba(0,212,240,.1);white-space:nowrap;background:rgba(0,153,187,.02);}
tbody tr{border-bottom:1px solid rgba(0,100,140,.1);transition:background .15s;animation:rowIn .3s ease;}
@keyframes rowIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:translateX(0)}}
tbody tr:hover{background:rgba(0,153,187,.04);}
tbody td{padding:11px 13px;font-size:.83rem;vertical-align:middle;}
.mono{font-family:'Space Mono',monospace;font-size:.72rem;}
.progress-bar{width:90px;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;transition:width .9s ease;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:50px;font-size:.65rem;font-family:'Space Mono',monospace;white-space:nowrap;}
.badge-complete{background:rgba(61,232,197,.1);color:#3de8c5;border:1px solid rgba(61,232,197,.25);}
.badge-progress{background:rgba(0,153,187,.08);color:var(--accent);border:1px solid rgba(0,120,160,.25);}
.badge-pending{background:rgba(245,166,35,.1);color:var(--accent2);border:1px solid rgba(245,166,35,.25);}
.badge-loss{background:rgba(255,92,122,.1);color:var(--danger);border:1px solid rgba(255,92,122,.25);}
.action-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 9px;color:var(--muted);cursor:pointer;font-size:.68rem;font-family:'Space Mono',monospace;transition:all .2s;}
.action-btn:hover{border-color:var(--danger);color:var(--danger);background:rgba(255,92,122,.06);}
.empty-state{text-align:center;padding:44px 20px;color:var(--muted);font-family:'Space Mono',monospace;font-size:.78rem;}
.empty-state .icon{font-size:2.4rem;margin-bottom:12px;opacity:.22;}
.section-title{font-size:.92rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent);}

/* model group header */
.group-header td{background:rgba(0,153,187,.07);font-weight:600;color:var(--accent);font-size:.8rem;letter-spacing:1px;padding:8px 13px;border-bottom:1px solid rgba(0,153,187,.2);border-top:1px solid rgba(0,120,160,.1);}
.group-summary td{background:rgba(0,168,130,.04);font-family:'Space Mono',monospace;font-size:.7rem;color:var(--accent3);padding:7px 13px;border-bottom:2px solid rgba(0,120,160,.15);}

/* ===== CHART TABS ===== */
.chart-tabs{display:flex;gap:4px;padding:12px 18px 0;border-bottom:1px solid rgba(0,212,240,.1);}
.chart-tab{padding:8px 14px;border-radius:8px 8px 0 0;font-family:'Space Mono',monospace;font-size:.62rem;color:var(--muted);cursor:pointer;transition:all .2s;border:1px solid transparent;border-bottom:none;position:relative;bottom:-1px;white-space:nowrap;}
.chart-tab:hover{color:var(--accent);}
.chart-tab.active{color:var(--accent);background:var(--surface);border-color:rgba(0,120,160,.2);border-bottom-color:var(--surface);}
.chart-pane{display:none;padding:18px 20px 20px;}
.chart-pane.active{display:block;}
.chart-legend{display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}

/* ===== REPORT SECTION ===== */
.report-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.report-view-tabs{display:flex;gap:4px;}
.report-view-tab{padding:8px 18px;border-radius:8px;font-family:'Space Mono',monospace;font-size:.68rem;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all .2s;}
.report-view-tab.active{background:rgba(0,153,187,.08);border-color:var(--accent);color:var(--accent);}
.report-date-filter{display:flex;align-items:center;gap:8px;margin-left:auto;}
.report-date-filter input{width:auto;padding:8px 12px;font-size:.78rem;}
.download-btns{display:flex;gap:8px;}

/* ===== LOSS REPORT ===== */
.loss-table-wrap{overflow-x:auto;}
.loss-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.loss-stat{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px 18px;}
.loss-stat-label{font-family:'Space Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;}
.loss-stat-val{font-size:1.6rem;font-weight:700;}

/* ===== ADMIN ===== */
.admin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:28px;}
.admin-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
.admin-card-header{padding:15px 20px;border-bottom:1px solid rgba(0,212,240,.1);display:flex;align-items:center;justify-content:space-between;}
.admin-card-title{font-size:.88rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.admin-card-body{padding:18px 20px;}
.admin-input-row{display:flex;gap:8px;margin-bottom:14px;}
.admin-input-row input,.admin-input-row select{flex:1;}
.admin-add-btn{background:linear-gradient(135deg,#0099bb,#007799);color:#ffffff;border:none;border-radius:9px;padding:0 16px;font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s;}
.admin-add-btn:hover{background:linear-gradient(135deg,#00aacc,#0088aa);}
.admin-list{list-style:none;max-height:220px;overflow-y:auto;}
.admin-list::-webkit-scrollbar{width:4px;}
.admin-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.admin-list li{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:8px;margin-bottom:4px;background:var(--surface2);font-family:'Space Mono',monospace;font-size:.76rem;color:var(--text2);animation:rowIn .3s ease;}
.admin-list li:hover{background:rgba(0,153,187,.08);}
.admin-delete-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;transition:all .2s;}
.admin-delete-btn:hover{color:var(--danger);background:rgba(255,92,122,.1);}
.count-badge{font-family:'Space Mono',monospace;font-size:.6rem;background:rgba(0,153,187,.08);border:1px solid rgba(0,120,160,.2);border-radius:50px;padding:3px 10px;color:var(--accent);}
.admin-empty{font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);text-align:center;padding:20px;opacity:.7;}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:24px;right:24px;background:linear-gradient(135deg,#0099bb,#007799);color:#ffffff;padding:11px 20px;border-radius:12px;font-family:'Outfit',sans-serif;font-size:.84rem;font-weight:600;z-index:999;opacity:0;transform:translateY(16px);transition:all .3s;box-shadow:0 8px 24px rgba(0,153,187,.3);}
.toast.show{opacity:1;transform:translateY(0);}
.toast.error{background:linear-gradient(135deg,#ff5c7a,#cc2244);color:#fff;}
.toast.warn{background:linear-gradient(135deg,#e07b10,#c06000);color:#ffffff;}

/* ===== DIFF NEGATIVE ===== */
.diff-neg{color:var(--danger);font-weight:600;}
.diff-pos{color:var(--accent3);font-weight:600;}

/* ===== RESPONSIVE ===== */
@media(max-width:1200px){.summary-grid{grid-template-columns:repeat(3,1fr);}.form-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:900px){.admin-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:600px){.summary-grid{grid-template-columns:1fr 1fr;}.form-grid{grid-template-columns:1fr;}.form-grid-3{grid-template-columns:1fr;}.form-grid-2{grid-template-columns:1fr;}.admin-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- ========== LOGIN ========== -->
<div id="loginPage" class="page active">
  <div class="login-card">
    <div class="login-header">
      <div class="login-logo-icon" style="display:none;">ABC</div>
      <div class="login-company"><span>Sungwoo Stamping Pvt Ltd</span></div>
      <div class="login-sub">Weldshop Department</div>
    </div>
    <div class="login-body">
      <div class="login-title">Sign in to ProdTrack</div>
      <div style="margin-bottom:16px;">
        <label>Login As</label>
        <div class="role-tabs">
          <div class="role-tab active" onclick="selectRole('admin')" id="roleAdmin">üîê Admin</div>
          <div class="role-tab" onclick="selectRole('operator')" id="roleOperator">üë∑ Operator</div>
        </div>
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="loginUser" placeholder="Enter username" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPass" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn btn-primary" onclick="doLogin()" style="margin-top:8px;">Sign In</button>
      <div class="login-error" id="loginError">Invalid username or password.</div>
      <div class="login-hint" style="display:none" >Admin: <b>admin</b> / <b>admin123</b><br>Operator: <b>operator</b> / <b>op123</b></div>
    </div>
  </div>
</div>

<!-- ========== MAIN APP ========== -->
<div id="appPage" class="page">

  <header>
    <div class="header-inner">
      <div class="company-logo">
        <div class="company-logo-icon" style="display:none;" >
          <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
            <rect width="38" height="38" rx="9" fill="url(#lg1)"/>
            <defs><linearGradient id="lg1" x1="0" y1="0" x2="38" y2="38"><stop stop-color="#0099bb"/><stop offset="1" stop-color="#007799"/></linearGradient></defs>
            <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Outfit" font-size="12" fill="#ffffff" font-weight="700" letter-spacing="1">Sungwoo Stamping Pvt Ltd</text>
          </svg>
        </div>
        <div>
          <div class="company-name"><span>Sungwoo Stamping Pvt Ltd</span></div>
          <div class="company-tagline">Weldshop Department</div>
        </div>
      </div>
      <div class="nav-links">
        <button class="nav-btn active" id="navDashboard" onclick="showSection('dashboard')">üìã Entry</button>
        <button class="nav-btn" id="navReports" onclick="showSection('reports')">üìä Reports</button>
        <button class="nav-btn" id="navLoss" onclick="showSection('loss')">‚ö†Ô∏è Loss Report</button>
        <button class="nav-btn" id="navAdmin" onclick="showSection('admin')" style="display:none;">‚öôÔ∏è Admin</button>
      </div>
      <div class="header-right">
        <div class="live-badge"><span class="status-dot"></span>LIVE &nbsp;|&nbsp; <span class="header-clock" id="clockDisplay"></span></div>
        <div class="user-pill"><div class="user-avatar" id="userAvatar">A</div><span id="userLabel">Admin</span></div>
        <button class="nav-btn logout" onclick="doLogout()">‚èª Logout</button>
      </div>
    </div>
  </header>

  <!-- ===== DASHBOARD / ENTRY ===== -->
  <div id="sectionDashboard">
    <main>
      <div class="container">

        <!-- Stat cards -->
        <div class="summary-grid">
          <div class="stat-card c1"><div class="stat-label">Total Entries</div><div class="stat-value" id="statEntries">0</div></div>
          <div class="stat-card c2"><div class="stat-label">Plan Qty</div><div class="stat-value" id="statPlan">0</div></div>
          <div class="stat-card c3"><div class="stat-label">Actual Qty</div><div class="stat-value" id="statActual">0</div></div>
          <div class="stat-card c4"><div class="stat-label">Diff Qty</div><div class="stat-value" id="statDiff">0</div></div>
          <div class="stat-card c5"><div class="stat-label">Total Loss Hrs</div><div class="stat-value" id="statLoss">0</div></div>
          <div class="stat-card c6"><div class="stat-label">Loss Entries</div><div class="stat-value" id="statLossCount">0</div></div>
        </div>

        <!-- Entry Form + Chart -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:24px;">

          <!-- FORM -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-header-left">
                <div class="panel-icon cyan">‚ûï</div>
                <div class="panel-title">Add Production Entry</div>
              </div>
            </div>
            <div class="panel-body">
              <!-- Row 1: Date, Shift, Model -->
              <div class="form-grid-3">
                <div class="fg">
                  <label>Date</label>
                  <input type="date" id="entryDate">
                </div>
                <div class="fg">
                  <label>Shift</label>
                  <select id="shift">
                    <option value="">‚Äî Shift ‚Äî</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                  </select>
                </div>
                <div class="fg">
                  <label>Model</label>
                  <select id="model"><option value="">‚Äî Select Model ‚Äî</option></select>
                </div>
              </div>
              <!-- Row 2: Part No, Variant, Assembly -->
              <div class="form-grid-3">
                <div class="fg">
                  <label>Part No.</label>
                  <select id="partNo"><option value="">‚Äî Select Part ‚Äî</option></select>
                </div>
                <div class="fg">
                  <label>Variant</label>
                  <select id="variant"><option value="">‚Äî Select Variant ‚Äî</option></select>
                </div>
                <div class="fg">
                  <label>Assembly Name</label>
                  <select id="assembly"><option value="">‚Äî Select Assembly ‚Äî</option></select>
                </div>
              </div>
              <!-- Row 3: UPH, Plan Qty, Actual Qty, Diff Qty -->
              <div class="form-grid">
                <div class="fg">
                  <label>UPH</label>
                  <input type="number" id="uph" min="0" placeholder="0">
                </div>
                <div class="fg">
                  <label>Plan Qty</label>
                  <input type="number" id="planQty" min="0" placeholder="0" oninput="calcDiff()">
                </div>
                <div class="fg">
                  <label>Actual Qty</label>
                  <input type="number" id="actualQty" min="0" placeholder="0" oninput="calcDiff()">
                </div>
                <div class="fg">
                  <label>Diff Qty</label>
                  <input type="number" id="diffQty" readonly placeholder="Auto" style="opacity:.6;cursor:not-allowed;">
                </div>
              </div>
              <!-- Row 4: Loss Hrs, Reason -->
              <div class="form-grid-2">
                <div class="fg">
                  <label>Loss Hrs</label>
                  <input type="number" id="lossHrs" min="0" step="0.5" placeholder="0.0">
                </div>
                <div class="fg">
                  <label>Reason</label>
                  <select id="reason">
                    <option value="">‚Äî Select Reason ‚Äî</option>
                    <option value="Material">Material</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Quality">Quality</option>
                    <option value="Manpower">Manpower</option>
                    <option value="Power Failure">Power Failure</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>
              <!-- Row 5: Response, Remarks -->
              <div class="form-grid-2">
                <div class="fg">
                  <label>Response</label>
                  <textarea id="response" placeholder="Action taken / response..."></textarea>
                </div>
                <div class="fg">
                  <label>Remarks</label>
                  <textarea id="remarks" placeholder="Additional remarks..."></textarea>
                </div>
              </div>
              <button class="btn btn-primary" onclick="addEntry()" style="margin-top:6px;">Add to Production Log</button>
            </div>
          </div>

          <!-- CHART -->
          <div class="panel">
            <div class="chart-tabs">
              <div class="chart-tab active" onclick="switchChartTab('tab-assembly')" id="ctab-assembly">üì¶ Actual vs Plan</div>
              <div class="chart-tab" onclick="switchChartTab('tab-progress')" id="ctab-progress">üìä Progress %</div>
              <div class="chart-tab" onclick="switchChartTab('tab-trend')" id="ctab-trend">üìà Trend</div>
            </div>
            <div class="chart-pane active" id="tab-assembly">
              <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#00d4f0"></div>Actual Qty</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f5a623"></div>Diff (Gap)</div>
              </div>
              <canvas id="areaAssembly" style="width:100%;height:230px;display:block;"></canvas>
            </div>
            <div class="chart-pane" id="tab-progress">
              <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#3de8c5"></div>Progress %</div>
              </div>
              <canvas id="areaProgress" style="width:100%;height:230px;display:block;"></canvas>
            </div>
            <div class="chart-pane" id="tab-trend">
              <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#00d4f0"></div>Cumulative Plan</div>
                <div class="legend-item"><div class="legend-dot" style="background:#3de8c5"></div>Cumulative Actual</div>
              </div>
              <canvas id="areaTrend" style="width:100%;height:230px;display:block;"></canvas>
            </div>
          </div>
        </div>

        <!-- PRODUCTION LOG TABLE (grouped by Model) -->
        <div class="section-title">Production Log ‚Äî Grouped by Model</div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-left">
              <div class="panel-icon teal">üìã</div>
              <div class="panel-title">All Entries</div>
            </div>
            <div style="display:flex;gap:8px;">
              <input type="text" id="searchInput" placeholder="üîç Search..." style="width:180px;padding:7px 12px;font-size:.78rem;" oninput="renderTable()">
            </div>
          </div>
          <div class="table-wrap">
            <table id="mainTable">
              <thead>
                <tr>
                  <th>#</th><th>Date</th><th>Shift</th><th>Model</th><th>Part No.</th>
                  <th>Variant</th><th>Assembly</th><th>UPH</th>
                  <th>Plan Qty</th><th>Actual Qty</th><th>Diff Qty</th>
                  <th>Loss Hrs</th><th>Reason</th><th>Response</th><th>Remarks</th><th>By</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="17"><div class="empty-state"><div class="icon">üè≠</div><div>No entries yet. Add one using the form.</div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- ===== REPORTS ===== -->
  <div id="sectionReports" style="display:none;">
    <main>
      <div class="container">
        <div class="section-title">Production Reports</div>

        <div class="report-toolbar">
          <div class="report-view-tabs">
            <div class="report-view-tab active" onclick="switchReportView('daily')" id="rvDaily">üìÖ Daily View</div>
            <div class="report-view-tab" onclick="switchReportView('monthly')" id="rvMonthly">üìÜ Monthly View</div>
          </div>
          <div class="report-date-filter" id="dailyFilter">
            <label style="margin-bottom:0;white-space:nowrap;">Filter Date:</label>
            <input type="date" id="filterDate" onchange="renderReport()">
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('filterDate').value='';renderReport()">Clear</button>
          </div>
          <div class="report-date-filter" id="monthlyFilter" style="display:none;">
            <label style="margin-bottom:0;white-space:nowrap;">Month:</label>
            <input type="month" id="filterMonth" onchange="renderReport()">
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('filterMonth').value='';renderReport()">Clear</button>
          </div>
          <div class="download-btns" style="margin-left:auto;">
            <button class="btn btn-success btn-sm" onclick="downloadExcel()">‚¨á Excel</button>
            <button class="btn btn-warn btn-sm" onclick="downloadPDF()">‚¨á PDF</button>
          </div>
        </div>

        <!-- Summary cards for filtered view -->
        <div class="summary-grid" id="reportStats" style="margin-bottom:20px;"></div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-left">
              <div class="panel-icon amber">üìä</div>
              <div class="panel-title" id="reportPanelTitle">Daily Production Report</div>
            </div>
          </div>
          <div class="table-wrap">
            <table id="reportTable">
              <thead>
                <tr>
                  <th>#</th><th>Date</th><th>Shift</th><th>Model</th><th>Part No.</th>
                  <th>Variant</th><th>Assembly</th><th>UPH</th>
                  <th>Plan Qty</th><th>Actual Qty</th><th>Diff Qty</th>
                  <th>Loss Hrs</th><th>Reason</th><th>Response</th><th>Remarks</th>
                </tr>
              </thead>
              <tbody id="reportBody">
                <tr><td colspan="15"><div class="empty-state"><div class="icon">üìä</div><div>No data for selected period.</div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== LOSS REPORT ===== -->
  <div id="sectionLoss" style="display:none;">
    <main>
      <div class="container">
        <div class="section-title">‚ö†Ô∏è Production Loss Report</div>

        <div class="report-toolbar">
          <div class="report-date-filter">
            <label style="margin-bottom:0;white-space:nowrap;">From:</label>
            <input type="date" id="lossFrom" onchange="renderLossReport()">
            <label style="margin-bottom:0;white-space:nowrap;">To:</label>
            <input type="date" id="lossTo" onchange="renderLossReport()">
            <button class="btn btn-outline btn-sm" onclick="clearLossFilter()">Clear</button>
          </div>
          <div class="download-btns" style="margin-left:auto;">
            <button class="btn btn-success btn-sm" onclick="downloadLossExcel()">‚¨á Excel</button>
            <button class="btn btn-warn btn-sm" onclick="downloadLossPDF()">‚¨á PDF</button>
          </div>
        </div>

        <div class="loss-stat-grid" id="lossStatGrid"></div>

        <!-- Loss by Reason -->
        <div class="section-title">Loss by Reason</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
          <div class="panel">
            <div class="panel-header"><div class="panel-header-left"><div class="panel-icon red">üìâ</div><div class="panel-title">Reason Breakdown</div></div></div>
            <div style="padding:18px;">
              <canvas id="lossReasonChart" style="width:100%;height:220px;display:block;"></canvas>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header"><div class="panel-header-left"><div class="panel-icon red">‚è±Ô∏è</div><div class="panel-title">Loss Hrs by Reason</div></div></div>
            <div style="padding:18px;">
              <canvas id="lossHrsChart" style="width:100%;height:220px;display:block;"></canvas>
            </div>
          </div>
        </div>

        <div class="section-title">Response & Action Log</div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-left"><div class="panel-icon red">üîß</div><div class="panel-title">Production Loss Entries ‚Äî Response Details</div></div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>#</th><th>Date</th><th>Shift</th><th>Model</th><th>Part No.</th><th>Assembly</th><th>Diff Qty</th><th>Loss Hrs</th><th>Reason</th><th>Response / Action Taken</th><th>Remarks</th></tr>
              </thead>
              <tbody id="lossBody">
                <tr><td colspan="11"><div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>No production loss entries found.</div></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== ADMIN ===== -->
  <div id="sectionAdmin" style="display:none;">
    <main>
      <div class="container">
        <div class="section-title">Admin Panel ‚Äî Master Data</div>
        <div class="admin-grid">
          <div class="admin-card">
            <div class="admin-card-header"><div class="admin-card-title"><span>üîß</span>Models</div><span class="count-badge" id="modelCount">0</span></div>
            <div class="admin-card-body">
              <div class="admin-input-row"><input type="text" id="newModel" placeholder="e.g. MX-500" onkeydown="if(event.key==='Enter')addMaster('models','newModel','modelList','modelCount')"><button class="admin-add-btn" onclick="addMaster('models','newModel','modelList','modelCount')">+ Add</button></div>
              <ul class="admin-list" id="modelList"></ul>
            </div>
          </div>
          <div class="admin-card">
            <div class="admin-card-header"><div class="admin-card-title"><span>üî¢</span>Part Numbers</div><span class="count-badge" id="partNoCount">0</span></div>
            <div class="admin-card-body">
              <div class="admin-input-row"><input type="text" id="newPartNo" placeholder="e.g. PT-20240001" onkeydown="if(event.key==='Enter')addMaster('partNos','newPartNo','partNoList','partNoCount')"><button class="admin-add-btn" onclick="addMaster('partNos','newPartNo','partNoList','partNoCount')">+ Add</button></div>
              <ul class="admin-list" id="partNoList"></ul>
            </div>
          </div>
          <div class="admin-card">
            <div class="admin-card-header"><div class="admin-card-title"><span>üèóÔ∏è</span>Assembly Names</div><span class="count-badge" id="assemblyCount">0</span></div>
            <div class="admin-card-body">
              <div class="admin-input-row"><input type="text" id="newAssembly" placeholder="e.g. Engine Block" onkeydown="if(event.key==='Enter')addMaster('assemblies','newAssembly','assemblyList','assemblyCount')"><button class="admin-add-btn" onclick="addMaster('assemblies','newAssembly','assemblyList','assemblyCount')">+ Add</button></div>
              <ul class="admin-list" id="assemblyList"></ul>
            </div>
          </div>
          <div class="admin-card">
            <div class="admin-card-header"><div class="admin-card-title"><span>üé®</span>Variants</div><span class="count-badge" id="variantCount">0</span></div>
            <div class="admin-card-body">
              <div class="admin-input-row"><input type="text" id="newVariant" placeholder="e.g. V1-Red" onkeydown="if(event.key==='Enter')addMaster('variants','newVariant','variantList','variantCount')"><button class="admin-add-btn" onclick="addMaster('variants','newVariant','variantList','variantCount')">+ Add</button></div>
              <ul class="admin-list" id="variantList"></ul>
            </div>
          </div>
          <div class="admin-card" style="grid-column:span 2;">
            <div class="admin-card-header"><div class="admin-card-title"><span>üë•</span>Users</div><span class="count-badge" id="userCountBadge">0</span></div>
            <div class="admin-card-body">
              <div class="admin-input-row">
                <input type="text" id="newUserName" placeholder="Username">
                <input type="password" id="newUserPass" placeholder="Password">
                <select id="newUserRole"><option value="admin">Admin</option><option value="operator">Operator</option></select>
                <button class="admin-add-btn" onclick="addUser()">+ Add</button>
              </div>
              <ul class="admin-list" id="userList" style="max-height:160px;"></ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

</div><!-- end appPage -->
<div class="toast" id="toast"></div>

<script>
/* ==================== DATABASE ==================== */
const DEFAULT_USERS=[
  {id:1,username:'admin',password:'admin123',role:'admin',added:'System'},
  {id:2,username:'operator',password:'op123',role:'operator',added:'System'}
];
let db={
  users:      JSON.parse(localStorage.getItem('pt_users'))      || DEFAULT_USERS,
  entries:    JSON.parse(localStorage.getItem('pt_entries'))    || [],
  models:     JSON.parse(localStorage.getItem('pt_models'))     || ['MX-500','TX-200','LX-900'],
  partNos:    JSON.parse(localStorage.getItem('pt_partNos'))    || ['PT-20240001','PT-20240002','PT-20240003'],
  assemblies: JSON.parse(localStorage.getItem('pt_assemblies')) || ['Engine Block','Gearbox','Frame','Exhaust'],
  variants:   JSON.parse(localStorage.getItem('pt_variants'))   || ['V1-Standard','V2-Premium','V3-Export'],
};
let currentUser=null, selectedRole='admin';
let activeChartTab='tab-assembly', activeReportView='daily';
function save(k){localStorage.setItem('pt_'+k,JSON.stringify(db[k]));}

/* ==================== LOGIN ==================== */
function selectRole(r){
  selectedRole=r;
  document.getElementById('roleAdmin').classList.toggle('active',r==='admin');
  document.getElementById('roleOperator').classList.toggle('active',r==='operator');
}
function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const user=db.users.find(x=>x.username===u&&x.password===p&&x.role===selectedRole);
  if(!user){document.getElementById('loginError').style.display='block';return;}
  document.getElementById('loginError').style.display='none';
  currentUser=user;
  document.getElementById('userLabel').textContent=user.username;
  document.getElementById('userAvatar').textContent=user.username[0].toUpperCase();
  document.getElementById('navAdmin').style.display=user.role==='admin'?'':'none';
  showPage('appPage');
  showSection('dashboard');
  // Set today's date as default
  document.getElementById('entryDate').value=new Date().toISOString().split('T')[0];
  render();
}
function doLogout(){
  currentUser=null;
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  showPage('loginPage');
}
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');}

/* ==================== ROUTING ==================== */
function showSection(sec){
  ['dashboard','reports','loss','admin'].forEach(s=>{
    const el=document.getElementById('section'+s.charAt(0).toUpperCase()+s.slice(1));
    if(el) el.style.display=sec===s?'':'none';
    const btn=document.getElementById('nav'+s.charAt(0).toUpperCase()+s.slice(1));
    if(btn) btn.classList.toggle('active',sec===s);
  });
  if(sec==='reports') renderReport();
  if(sec==='loss') renderLossReport();
  if(sec==='admin') renderAdmin();
}

/* ==================== FORM ==================== */
function calcDiff(){
  const plan=parseInt(document.getElementById('planQty').value)||0;
  const actual=parseInt(document.getElementById('actualQty').value)||0;
  document.getElementById('diffQty').value=plan-actual;
}

function addEntry(){
  const date=document.getElementById('entryDate').value;
  const shift=document.getElementById('shift').value;
  const model=document.getElementById('model').value;
  const partNo=document.getElementById('partNo').value;
  const variant=document.getElementById('variant').value;
  const assembly=document.getElementById('assembly').value;
  const uph=parseFloat(document.getElementById('uph').value)||0;
  const planQty=parseInt(document.getElementById('planQty').value)||0;
  const actualQty=parseInt(document.getElementById('actualQty').value)||0;
  const lossHrs=parseFloat(document.getElementById('lossHrs').value)||0;
  const reason=document.getElementById('reason').value;
  const response=document.getElementById('response').value.trim();
  const remarks=document.getElementById('remarks').value.trim();

  if(!date||!shift||!model||!partNo||!assembly){showToast('Please fill all required fields (Date, Shift, Model, Part No, Assembly).','error');return;}

  const diffQty=planQty-actualQty;
  db.entries.push({
    id:Date.now(),date,shift,model,partNo,variant,assembly,uph,
    planQty,actualQty,diffQty,lossHrs,reason,response,remarks,
    addedBy:currentUser?currentUser.username:'‚Äî',
    ts:Date.now()
  });
  save('entries'); render(); showToast('Entry added!');
  // Clear qty fields only
  ['uph','planQty','actualQty','diffQty','lossHrs','response','remarks'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('reason').value='';
}

function deleteEntry(id){
  if(!confirm('Delete this entry?'))return;
  db.entries=db.entries.filter(e=>e.id!==id);
  save('entries'); render(); showToast('Entry deleted.');
}

/* ==================== RENDER ==================== */
function render(){renderDropdowns();renderStats();renderTable();renderCharts();}

function renderDropdowns(){
  [['model','models'],['partNo','partNos'],['variant','variants'],['assembly','assemblies']].forEach(([fid,key])=>{
    const sel=document.getElementById(fid);if(!sel)return;
    const cur=sel.value;
    sel.innerHTML='<option value="">‚Äî Select ‚Äî</option>'+db[key].map(v=>`<option value="${v}"${v===cur?' selected':''}>${v}</option>`).join('');
  });
}

function renderStats(){
  const entries=db.entries;
  document.getElementById('statEntries').textContent=entries.length;
  document.getElementById('statPlan').textContent=entries.reduce((s,e)=>s+e.planQty,0);
  document.getElementById('statActual').textContent=entries.reduce((s,e)=>s+e.actualQty,0);
  const diff=entries.reduce((s,e)=>s+e.diffQty,0);
  const statDiff=document.getElementById('statDiff');
  statDiff.textContent=diff;
  statDiff.style.color=diff>0?'var(--danger)':diff<0?'var(--accent3)':'var(--text)';
  document.getElementById('statLoss').textContent=entries.reduce((s,e)=>s+e.lossHrs,0).toFixed(1);
  document.getElementById('statLossCount').textContent=entries.filter(e=>e.lossHrs>0||e.reason).length;
}

function renderTable(){
  const tbody=document.getElementById('tableBody');
  const q=(document.getElementById('searchInput')||{value:''}).value.toLowerCase();
  let entries=db.entries.filter(e=>!q||(e.model+e.partNo+e.assembly+e.variant+e.date+e.shift+e.reason+e.response+e.remarks).toLowerCase().includes(q));

  if(!entries.length){
    tbody.innerHTML='<tr><td colspan="17"><div class="empty-state"><div class="icon">üè≠</div><div>No entries found.</div></div></td></tr>';
    return;
  }

  // Group by model
  const groups={};
  entries.forEach(e=>{
    if(!groups[e.model]) groups[e.model]=[];
    groups[e.model].push(e);
  });

  let html='',rowNum=1;
  Object.keys(groups).forEach(model=>{
    const grp=groups[model];
    const gPlan=grp.reduce((s,e)=>s+e.planQty,0);
    const gActual=grp.reduce((s,e)=>s+e.actualQty,0);
    const gDiff=grp.reduce((s,e)=>s+e.diffQty,0);
    const gLoss=grp.reduce((s,e)=>s+e.lossHrs,0);

    html+=`<tr class="group-header"><td colspan="17">üîß Model: ${model} &nbsp;|&nbsp; ${grp.length} entries &nbsp;|&nbsp; Plan: ${gPlan} &nbsp;|&nbsp; Actual: ${gActual} &nbsp;|&nbsp; Diff: <span style="color:${gDiff>0?'var(--danger)':'var(--accent3)'}">${gDiff>0?'+':''}${gDiff}</span> &nbsp;|&nbsp; Loss Hrs: ${gLoss.toFixed(1)}</td></tr>`;

    grp.forEach(e=>{
      const diffC=e.diffQty>0?'diff-neg':e.diffQty<0?'diff-pos':'';
      const canDel=currentUser&&(currentUser.role==='admin'||e.addedBy===currentUser.username);
      html+=`<tr>
        <td class="mono" style="color:var(--muted)">${String(rowNum++).padStart(2,'0')}</td>
        <td class="mono" style="color:var(--text2)">${e.date}</td>
        <td><span class="badge badge-progress">Shift ${e.shift}</span></td>
        <td style="color:var(--accent);font-weight:600">${e.model}</td>
        <td class="mono" style="color:var(--text2)">${e.partNo}</td>
        <td style="color:var(--muted)">${e.variant||'‚Äî'}</td>
        <td>${e.assembly}</td>
        <td class="mono">${e.uph||'‚Äî'}</td>
        <td class="mono" style="font-weight:600">${e.planQty}</td>
        <td class="mono" style="color:var(--accent3)">${e.actualQty}</td>
        <td class="mono ${diffC}">${e.diffQty>0?'+':''}${e.diffQty}</td>
        <td class="mono" style="color:${e.lossHrs>0?'var(--danger)':'var(--muted)'}">${e.lossHrs>0?e.lossHrs.toFixed(1):'‚Äî'}</td>
        <td>${e.reason?`<span class="badge badge-loss">${e.reason}</span>`:'‚Äî'}</td>
        <td style="font-size:.78rem;color:var(--text2);max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${e.response||''}">${e.response||'‚Äî'}</td>
        <td style="font-size:.78rem;color:var(--muted);max-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${e.remarks||''}">${e.remarks||'‚Äî'}</td>
        <td class="mono" style="color:var(--muted);font-size:.7rem">${e.addedBy||'‚Äî'}</td>
        <td>${canDel?`<button class="action-btn" onclick="deleteEntry(${e.id})">‚úï</button>`:'‚Äî'}</td>
      </tr>`;
    });

    html+=`<tr class="group-summary"><td colspan="17">‚Ü≥ Sub-total ‚Äî Plan: ${gPlan} | Actual: ${gActual} | Diff: ${gDiff>0?'+':''}${gDiff} | Loss Hrs: ${gLoss.toFixed(1)}</td></tr>`;
  });
  tbody.innerHTML=html;
}

/* ==================== CHARTS ==================== */
function switchChartTab(tab){
  activeChartTab=tab;
  document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.chart-pane').forEach(p=>p.classList.remove('active'));
  document.getElementById('ctab-'+tab.replace('tab-','')).classList.add('active');
  document.getElementById(tab).classList.add('active');
  renderCharts();
}
function renderCharts(){
  if(activeChartTab==='tab-assembly') renderAreaAssembly();
  else if(activeChartTab==='tab-progress') renderAreaProgress();
  else renderAreaTrend();
}
function fitCanvas(canvas){
  const rect=canvas.getBoundingClientRect();
  if(!rect.width) return null;
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
  return{ctx,W:rect.width,H:rect.height};
}
function drawSmooth(ctx,pts){
  if(!pts.length)return;
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length;i++){const cx=(pts[i-1].x+pts[i].x)/2;ctx.bezierCurveTo(cx,pts[i-1].y,cx,pts[i].y,pts[i].x,pts[i].y);}
}
function drawGrid(ctx,W,H,PAD,maxVal,color='rgba(0,120,160,.07)'){
  [0,.25,.5,.75,1].forEach(f=>{
    const y=PAD.t+(H-PAD.t-PAD.b)*(1-f);
    ctx.strokeStyle=color; ctx.lineWidth=1; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(PAD.l,y); ctx.lineTo(W-PAD.r,y); ctx.stroke(); ctx.setLineDash([]);
    if(f>0){ctx.fillStyle='rgba(60,110,140,.5)';ctx.font='9px Space Mono';ctx.textAlign='right';ctx.fillText(Math.round(maxVal*f),PAD.l-5,y+3);}
  });
}
function drawEmpty(ctx,W,H,msg='Add entries to see data'){
  ctx.fillStyle='rgba(60,110,140,.4)';ctx.font='11px Space Mono';ctx.textAlign='center';ctx.fillText(msg,W/2,H/2);
}

function renderAreaAssembly(){
  const canvas=document.getElementById('areaAssembly');
  const r=fitCanvas(canvas); if(!r)return;
  const{ctx,W,H}=r; ctx.clearRect(0,0,W,H);
  const grps={};
  db.entries.forEach(e=>{if(!grps[e.model])grps[e.model]={plan:0,actual:0};grps[e.model].plan+=e.planQty;grps[e.model].actual+=e.actualQty;});
  const keys=Object.keys(grps);
  if(!keys.length){drawEmpty(ctx,W,H);return;}
  const PAD={l:48,r:20,t:14,b:36};
  const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
  const maxVal=Math.max(...keys.map(k=>grps[k].plan),1);
  const xOf=i=>PAD.l+(i/Math.max(keys.length-1,1))*cW;
  const yOf=v=>PAD.t+cH-(v/maxVal)*cH;
  const baseY=PAD.t+cH;
  drawGrid(ctx,W,H,PAD,maxVal);
  // plan area (dashed)
  const planPts=keys.map((k,i)=>({x:xOf(i),y:yOf(grps[k].plan)}));
  ctx.strokeStyle='rgba(220,120,16,.45)';ctx.lineWidth=1.5;ctx.setLineDash([5,3]);
  ctx.beginPath();drawSmooth(ctx,planPts);ctx.stroke();ctx.setLineDash([]);
  // actual area
  const actPts=keys.map((k,i)=>({x:xOf(i),y:yOf(grps[k].actual)}));
  const ag=ctx.createLinearGradient(0,PAD.t,0,baseY);ag.addColorStop(0,'rgba(0,153,187,.35)');ag.addColorStop(1,'rgba(0,153,187,.03)');
  ctx.fillStyle=ag;ctx.beginPath();drawSmooth(ctx,actPts);ctx.lineTo(actPts[actPts.length-1].x,baseY);ctx.lineTo(actPts[0].x,baseY);ctx.closePath();ctx.fill();
  ctx.strokeStyle='#0099bb';ctx.lineWidth=2.5;ctx.shadowColor='rgba(0,212,240,.4)';ctx.shadowBlur=8;ctx.beginPath();drawSmooth(ctx,actPts);ctx.stroke();ctx.shadowBlur=0;
  actPts.forEach(pt=>{ctx.beginPath();ctx.arc(pt.x,pt.y,4,0,Math.PI*2);ctx.fillStyle='#0099bb';ctx.fill();ctx.strokeStyle='#c8d9e8';ctx.lineWidth=1.5;ctx.stroke();});
  ctx.fillStyle='rgba(60,110,140,.7)';ctx.font='9px Space Mono';ctx.textAlign='center';
  keys.forEach((k,i)=>ctx.fillText(k.length>8?k.substring(0,7)+'‚Ä¶':k,xOf(i),H-PAD.b+13));
}

function renderAreaProgress(){
  const canvas=document.getElementById('areaProgress');
  const r=fitCanvas(canvas); if(!r)return;
  const{ctx,W,H}=r; ctx.clearRect(0,0,W,H);
  if(!db.entries.length){drawEmpty(ctx,W,H);return;}
  const PAD={l:44,r:20,t:14,b:36};
  const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
  const baseY=PAD.t+cH;
  [0,25,50,75,100].forEach(v=>{
    const y=PAD.t+cH-(v/100)*cH;
    ctx.strokeStyle='rgba(0,168,130,.07)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(W-PAD.r,y);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='rgba(60,110,140,.5)';ctx.font='9px Space Mono';ctx.textAlign='right';ctx.fillText(v+'%',PAD.l-5,y+3);
  });
  const pts=db.entries.map((e,i)=>({
    x:PAD.l+(i/Math.max(db.entries.length-1,1))*cW,
    y:PAD.t+cH-((e.planQty>0?e.actualQty/e.planQty:0)*cH),
    pct:e.planQty>0?Math.round((e.actualQty/e.planQty)*100):0,
    label:e.model
  }));
  const ag=ctx.createLinearGradient(0,PAD.t,0,baseY);ag.addColorStop(0,'rgba(0,168,130,.3)');ag.addColorStop(1,'rgba(0,168,130,.03)');
  ctx.fillStyle=ag;ctx.beginPath();drawSmooth(ctx,pts);ctx.lineTo(pts[pts.length-1].x,baseY);ctx.lineTo(pts[0].x,baseY);ctx.closePath();ctx.fill();
  ctx.strokeStyle='#00a882';ctx.lineWidth=2.5;ctx.shadowColor='rgba(0,168,130,.4)';ctx.shadowBlur=8;ctx.beginPath();drawSmooth(ctx,pts);ctx.stroke();ctx.shadowBlur=0;
  pts.forEach(pt=>{
    const col=pt.pct>=100?'#00a882':pt.pct>=50?'#0099bb':'#e07b10';
    ctx.beginPath();ctx.arc(pt.x,pt.y,5,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();ctx.strokeStyle='#c8d9e8';ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle='rgba(20,50,70,.8)';ctx.font='bold 9px Space Mono';ctx.textAlign='center';ctx.fillText(pt.pct+'%',pt.x,pt.y-10);
    ctx.fillStyle='rgba(60,110,140,.7)';ctx.font='9px Space Mono';
    const lbl=pt.label.length>7?pt.label.substring(0,6)+'‚Ä¶':pt.label;
    ctx.fillText(lbl,pt.x,H-PAD.b+13);
  });
}

function renderAreaTrend(){
  const canvas=document.getElementById('areaTrend');
  const r=fitCanvas(canvas); if(!r)return;
  const{ctx,W,H}=r; ctx.clearRect(0,0,W,H);
  if(!db.entries.length){drawEmpty(ctx,W,H);return;}
  const PAD={l:52,r:20,t:14,b:36};
  const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
  let cPlan=0,cActual=0;
  const series=db.entries.map((e,i)=>{cPlan+=e.planQty;cActual+=e.actualQty;return{i,cPlan,cActual,label:'#'+String(i+1).padStart(2,'0')};});
  const maxVal=series[series.length-1].cPlan||1;
  const xOf=i=>PAD.l+(i/Math.max(series.length-1,1))*cW;
  const yOf=v=>PAD.t+cH-(v/maxVal)*cH;
  const baseY=PAD.t+cH;
  drawGrid(ctx,W,H,PAD,maxVal);
  const planPts=series.map((s,i)=>({x:xOf(i),y:yOf(s.cPlan)}));
  const pg=ctx.createLinearGradient(0,PAD.t,0,baseY);pg.addColorStop(0,'rgba(0,153,187,.22)');pg.addColorStop(1,'rgba(0,153,187,.02)');
  ctx.fillStyle=pg;ctx.beginPath();drawSmooth(ctx,planPts);ctx.lineTo(planPts[planPts.length-1].x,baseY);ctx.lineTo(planPts[0].x,baseY);ctx.closePath();ctx.fill();
  ctx.strokeStyle='rgba(0,153,187,.5)';ctx.lineWidth=1.5;ctx.setLineDash([5,3]);ctx.beginPath();drawSmooth(ctx,planPts);ctx.stroke();ctx.setLineDash([]);
  const actPts=series.map((s,i)=>({x:xOf(i),y:yOf(s.cActual)}));
  const ag=ctx.createLinearGradient(0,PAD.t,0,baseY);ag.addColorStop(0,'rgba(0,168,130,.35)');ag.addColorStop(1,'rgba(0,168,130,.03)');
  ctx.fillStyle=ag;ctx.beginPath();drawSmooth(ctx,actPts);ctx.lineTo(actPts[actPts.length-1].x,baseY);ctx.lineTo(actPts[0].x,baseY);ctx.closePath();ctx.fill();
  ctx.strokeStyle='#00a882';ctx.lineWidth=2.5;ctx.shadowColor='rgba(0,168,130,.35)';ctx.shadowBlur=8;ctx.beginPath();drawSmooth(ctx,actPts);ctx.stroke();ctx.shadowBlur=0;
  actPts.forEach(pt=>{ctx.beginPath();ctx.arc(pt.x,pt.y,4,0,Math.PI*2);ctx.fillStyle='#00a882';ctx.fill();ctx.strokeStyle='#c8d9e8';ctx.lineWidth=1.5;ctx.stroke();});
  ctx.fillStyle='rgba(60,110,140,.7)';ctx.font='9px Space Mono';ctx.textAlign='center';
  series.forEach((s,i)=>ctx.fillText(s.label,xOf(i),H-PAD.b+13));
  if(series.length){
    const last=series[series.length-1];
    ctx.textAlign='left';ctx.font='9px Space Mono';
    ctx.fillStyle='rgba(0,130,160,.9)';ctx.fillText('Plan: '+last.cPlan,xOf(series.length-1)+6,yOf(last.cPlan)-4);
    ctx.fillStyle='rgba(0,140,110,.9)';ctx.fillText('Actual: '+last.cActual,xOf(series.length-1)+6,yOf(last.cActual)-4);
  }
}

/* ==================== REPORTS ==================== */
function switchReportView(v){
  activeReportView=v;
  document.getElementById('rvDaily').classList.toggle('active',v==='daily');
  document.getElementById('rvMonthly').classList.toggle('active',v==='monthly');
  document.getElementById('dailyFilter').style.display=v==='daily'?'flex':'none';
  document.getElementById('monthlyFilter').style.display=v==='monthly'?'flex':'none';
  document.getElementById('reportPanelTitle').textContent=v==='daily'?'Daily Production Report':'Monthly Production Report';
  renderReport();
}

function getFilteredEntries(){
  if(activeReportView==='daily'){
    const fd=document.getElementById('filterDate').value;
    return fd?db.entries.filter(e=>e.date===fd):db.entries;
  } else {
    const fm=document.getElementById('filterMonth').value;
    return fm?db.entries.filter(e=>e.date&&e.date.startsWith(fm)):db.entries;
  }
}

function renderReport(){
  const entries=getFilteredEntries();
  const tbody=document.getElementById('reportBody');
  // summary stats
  const statsEl=document.getElementById('reportStats');
  const plan=entries.reduce((s,e)=>s+e.planQty,0);
  const actual=entries.reduce((s,e)=>s+e.actualQty,0);
  const diff=entries.reduce((s,e)=>s+e.diffQty,0);
  const loss=entries.reduce((s,e)=>s+e.lossHrs,0);
  statsEl.innerHTML=`
    <div class="stat-card c1"><div class="stat-label">Entries</div><div class="stat-value">${entries.length}</div></div>
    <div class="stat-card c2"><div class="stat-label">Plan Qty</div><div class="stat-value">${plan}</div></div>
    <div class="stat-card c3"><div class="stat-label">Actual Qty</div><div class="stat-value">${actual}</div></div>
    <div class="stat-card c4"><div class="stat-label">Diff Qty</div><div class="stat-value" style="color:${diff>0?'var(--danger)':'var(--accent3)'}">${diff>0?'+':''}${diff}</div></div>
    <div class="stat-card c5"><div class="stat-label">Loss Hrs</div><div class="stat-value">${loss.toFixed(1)}</div></div>
    <div class="stat-card c6"><div class="stat-label">Loss Entries</div><div class="stat-value">${entries.filter(e=>e.lossHrs>0||e.reason).length}</div></div>`;

  if(!entries.length){tbody.innerHTML='<tr><td colspan="15"><div class="empty-state"><div class="icon">üìä</div><div>No data for selected period.</div></div></td></tr>';return;}
  tbody.innerHTML=entries.map((e,i)=>{
    const dc=e.diffQty>0?'color:var(--danger);font-weight:600':e.diffQty<0?'color:var(--accent3);font-weight:600':'';
    return`<tr>
      <td class="mono" style="color:var(--muted)">${i+1}</td>
      <td class="mono">${e.date}</td>
      <td><span class="badge badge-progress">Shift ${e.shift}</span></td>
      <td style="color:var(--accent);font-weight:600">${e.model}</td>
      <td class="mono">${e.partNo}</td>
      <td style="color:var(--muted)">${e.variant||'‚Äî'}</td>
      <td>${e.assembly}</td>
      <td class="mono">${e.uph||'‚Äî'}</td>
      <td class="mono;font-weight:600">${e.planQty}</td>
      <td class="mono" style="color:var(--accent3)">${e.actualQty}</td>
      <td class="mono" style="${dc}">${e.diffQty>0?'+':''}${e.diffQty}</td>
      <td class="mono" style="color:${e.lossHrs>0?'var(--danger)':'var(--muted)'}">${e.lossHrs>0?e.lossHrs.toFixed(1):'‚Äî'}</td>
      <td>${e.reason?`<span class="badge badge-loss">${e.reason}</span>`:'‚Äî'}</td>
      <td style="font-size:.78rem;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.response||'‚Äî'}</td>
      <td style="font-size:.78rem;color:var(--muted)">${e.remarks||'‚Äî'}</td>
    </tr>`;
  }).join('');
}

/* ==================== LOSS REPORT ==================== */
function clearLossFilter(){
  document.getElementById('lossFrom').value='';
  document.getElementById('lossTo').value='';
  renderLossReport();
}

function renderLossReport(){
  const from=document.getElementById('lossFrom').value;
  const to=document.getElementById('lossTo').value;
  let entries=db.entries.filter(e=>e.lossHrs>0||e.reason);
  if(from) entries=entries.filter(e=>e.date>=from);
  if(to) entries=entries.filter(e=>e.date<=to);

  // Stats
  const totalLossHrs=entries.reduce((s,e)=>s+e.lossHrs,0);
  const totalDiff=entries.reduce((s,e)=>s+e.diffQty,0);
  const reasons={};
  entries.forEach(e=>{if(e.reason){reasons[e.reason]=(reasons[e.reason]||0)+1;}});
  const topReason=Object.keys(reasons).sort((a,b)=>reasons[b]-reasons[a])[0]||'‚Äî';

  document.getElementById('lossStatGrid').innerHTML=`
    <div class="loss-stat"><div class="loss-stat-label">Total Loss Hrs</div><div class="loss-stat-val" style="color:var(--danger)">${totalLossHrs.toFixed(1)}</div></div>
    <div class="loss-stat"><div class="loss-stat-label">Total Diff Qty</div><div class="loss-stat-val" style="color:var(--accent2)">${totalDiff>0?'+':''}${totalDiff}</div></div>
    <div class="loss-stat"><div class="loss-stat-label">Top Reason</div><div class="loss-stat-val" style="font-size:1.2rem;color:var(--accent)">${topReason}</div></div>`;

  // Loss table
  const tbody=document.getElementById('lossBody');
  if(!entries.length){tbody.innerHTML='<tr><td colspan="11"><div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>No production loss entries found.</div></div></td></tr>';renderLossCharts([]);return;}
  tbody.innerHTML=entries.map((e,i)=>`<tr>
    <td class="mono" style="color:var(--muted)">${i+1}</td>
    <td class="mono">${e.date}</td>
    <td><span class="badge badge-progress">Shift ${e.shift}</span></td>
    <td style="color:var(--accent);font-weight:600">${e.model}</td>
    <td class="mono">${e.partNo}</td>
    <td>${e.assembly}</td>
    <td class="mono" style="color:${e.diffQty>0?'var(--danger)':'var(--accent3)'};">${e.diffQty>0?'+':''}${e.diffQty}</td>
    <td class="mono" style="color:var(--danger);font-weight:600">${e.lossHrs>0?e.lossHrs.toFixed(1):'‚Äî'}</td>
    <td>${e.reason?`<span class="badge badge-loss">${e.reason}</span>`:'‚Äî'}</td>
    <td style="font-size:.8rem;color:var(--text2)">${e.response||'‚Äî'}</td>
    <td style="font-size:.78rem;color:var(--muted)">${e.remarks||'‚Äî'}</td>
  </tr>`).join('');

  renderLossCharts(entries);
}

function renderLossCharts(entries){
  // Reason count chart
  const reasons={};
  const lossHrsByReason={};
  entries.forEach(e=>{
    if(e.reason){
      reasons[e.reason]=(reasons[e.reason]||0)+1;
      lossHrsByReason[e.reason]=(lossHrsByReason[e.reason]||0)+e.lossHrs;
    }
  });
  drawHorizBar('lossReasonChart',reasons,'Occurrences','#ff5c7a');
  drawHorizBar('lossHrsChart',lossHrsByReason,'Loss Hrs','#e07b10');
}

function drawHorizBar(canvasId,dataObj,unit,color){
  const canvas=document.getElementById(canvasId);
  const r=fitCanvas(canvas); if(!r)return;
  const{ctx,W,H}=r; ctx.clearRect(0,0,W,H);
  const keys=Object.keys(dataObj);
  if(!keys.length){drawEmpty(ctx,W,H,'No data');return;}
  const maxVal=Math.max(...keys.map(k=>dataObj[k]),1);
  const barH=Math.min(28,(H-20)/keys.length-6);
  const PAD={l:90,r:50,t:12,b:12};
  const cW=W-PAD.l-PAD.r;
  keys.forEach((k,i)=>{
    const y=PAD.t+i*(barH+8);
    const bW=(dataObj[k]/maxVal)*cW;
    // bg bar
    ctx.fillStyle='rgba(0,100,140,.05)';
    if(ctx.roundRect){ctx.beginPath();ctx.roundRect(PAD.l,y,cW,barH,4);ctx.fill();}
    else{ctx.fillRect(PAD.l,y,cW,barH);}
    // value bar
    const gr=ctx.createLinearGradient(PAD.l,0,PAD.l+bW,0);
    gr.addColorStop(0,color);gr.addColorStop(1,color+'88');
    ctx.fillStyle=gr;
    if(ctx.roundRect){ctx.beginPath();ctx.roundRect(PAD.l,y,bW,barH,4);ctx.fill();}
    else{ctx.fillRect(PAD.l,y,bW,barH);}
    // label
    ctx.fillStyle='rgba(30,70,100,.8)';ctx.font='10px Space Mono';ctx.textAlign='right';
    ctx.fillText(k,PAD.l-6,y+barH/2+3.5);
    // value
    ctx.fillStyle='rgba(20,50,70,.85)';ctx.textAlign='left';
    ctx.fillText(dataObj[k],PAD.l+bW+6,y+barH/2+3.5);
  });
}

/* ==================== EXCEL / PDF DOWNLOAD ==================== */
function getReportData(){return getFilteredEntries();}

function buildExcelData(entries){
  return [
    ['Date','Shift','Model','Part No.','Variant','Assembly','UPH','Plan Qty','Actual Qty','Diff Qty','Loss Hrs','Reason','Response','Remarks','Added By'],
    ...entries.map(e=>[e.date,e.shift,e.model,e.partNo,e.variant||'',e.assembly,e.uph||0,e.planQty,e.actualQty,e.diffQty,e.lossHrs||0,e.reason||'',e.response||'',e.remarks||'',e.addedBy||''])
  ];
}

function downloadExcel(){
  const entries=getReportData();
  if(!entries.length){showToast('No data to export.','warn');return;}
  const ws=XLSX.utils.aoa_to_sheet(buildExcelData(entries));
  ws['!cols']=[{wch:12},{wch:7},{wch:12},{wch:14},{wch:12},{wch:16},{wch:8},{wch:10},{wch:11},{wch:9},{wch:10},{wch:14},{wch:24},{wch:24},{wch:12}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Production Report');
  const label=activeReportView==='daily'?(document.getElementById('filterDate').value||'All'):(document.getElementById('filterMonth').value||'All');
  XLSX.writeFile(wb,`ProdTrack_Report_${label}.xlsx`);
  showToast('Excel downloaded!');
}

function downloadPDF(){
  const entries=getReportData();
  if(!entries.length){showToast('No data to export.','warn');return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
  doc.setFont('helvetica','bold');
  doc.setFontSize(14);
  doc.setTextColor(0,100,150);
  doc.text('Sungwoo Stamping Pvt Ltd ‚Äì Production Report',14,14);
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.setTextColor(100,100,100);
  const label=activeReportView==='daily'?(document.getElementById('filterDate').value||'All Dates'):(document.getElementById('filterMonth').value||'All Months');
  doc.text(`Period: ${label}  |  Generated: ${new Date().toLocaleString()}`,14,20);
  doc.autoTable({
    startY:25,
    head:[['Date','Shift','Model','Part No.','Variant','Assembly','UPH','Plan','Actual','Diff','Loss Hrs','Reason','Response','Remarks']],
    body:entries.map(e=>[e.date,e.shift,e.model,e.partNo,e.variant||'',e.assembly,e.uph||0,e.planQty,e.actualQty,e.diffQty>0?'+'+e.diffQty:e.diffQty,e.lossHrs||0,e.reason||'',e.response||'',e.remarks||'']),
    styles:{fontSize:7,cellPadding:2},
    headStyles:{fillColor:[4,58,94],textColor:[0,212,240],fontStyle:'bold'},
    alternateRowStyles:{fillColor:[240,248,255]},
    columnStyles:{9:{textColor:entries.some(e=>e.diffQty>0)?[200,50,50]:[50,180,130]}},
    margin:{left:14,right:14}
  });
  const label2=activeReportView==='daily'?(document.getElementById('filterDate').value||'All'):(document.getElementById('filterMonth').value||'All');
  doc.save(`ProdTrack_Report_${label2}.pdf`);
  showToast('PDF downloaded!');
}

function downloadLossExcel(){
  const from=document.getElementById('lossFrom').value;
  const to=document.getElementById('lossTo').value;
  let entries=db.entries.filter(e=>e.lossHrs>0||e.reason);
  if(from) entries=entries.filter(e=>e.date>=from);
  if(to) entries=entries.filter(e=>e.date<=to);
  if(!entries.length){showToast('No loss data to export.','warn');return;}
  const ws=XLSX.utils.aoa_to_sheet([
    ['Date','Shift','Model','Part No.','Assembly','Diff Qty','Loss Hrs','Reason','Response / Action Taken','Remarks'],
    ...entries.map(e=>[e.date,e.shift,e.model,e.partNo,e.assembly,e.diffQty,e.lossHrs||0,e.reason||'',e.response||'',e.remarks||''])
  ]);
  ws['!cols']=[{wch:12},{wch:7},{wch:12},{wch:14},{wch:16},{wch:9},{wch:10},{wch:14},{wch:30},{wch:24}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Loss Report');
  XLSX.writeFile(wb,`ProdTrack_LossReport_${from||'All'}_${to||'All'}.xlsx`);
  showToast('Loss Excel downloaded!');
}

function downloadLossPDF(){
  const from=document.getElementById('lossFrom').value;
  const to=document.getElementById('lossTo').value;
  let entries=db.entries.filter(e=>e.lossHrs>0||e.reason);
  if(from) entries=entries.filter(e=>e.date>=from);
  if(to) entries=entries.filter(e=>e.date<=to);
  if(!entries.length){showToast('No loss data to export.','warn');return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
  doc.setFont('helvetica','bold');doc.setFontSize(14);doc.setTextColor(180,30,60);
  doc.text('Sungwoo Stamping Pvt Ltd ‚Äì Production Loss Report',14,14);
  doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(100,100,100);
  doc.text(`Period: ${from||'All'} to ${to||'All'}  |  Generated: ${new Date().toLocaleString()}`,14,20);
  const totalLoss=entries.reduce((s,e)=>s+e.lossHrs,0);
  const totalDiff=entries.reduce((s,e)=>s+e.diffQty,0);
  doc.setTextColor(200,50,50);doc.setFont('helvetica','bold');
  doc.text(`Total Loss Hours: ${totalLoss.toFixed(1)}  |  Total Diff Qty: ${totalDiff}  |  Entries: ${entries.length}`,14,26);
  doc.autoTable({
    startY:31,
    head:[['Date','Shift','Model','Part No.','Assembly','Diff Qty','Loss Hrs','Reason','Response / Action Taken','Remarks']],
    body:entries.map(e=>[e.date,e.shift,e.model,e.partNo,e.assembly,e.diffQty>0?'+'+e.diffQty:e.diffQty,e.lossHrs||0,e.reason||'',e.response||'',e.remarks||'']),
    styles:{fontSize:7,cellPadding:2},
    headStyles:{fillColor:[120,10,30],textColor:[255,200,200],fontStyle:'bold'},
    alternateRowStyles:{fillColor:[255,245,245]},
    margin:{left:14,right:14}
  });
  doc.save(`ProdTrack_LossReport_${from||'All'}_${to||'All'}.pdf`);
  showToast('Loss PDF downloaded!');
}

/* ==================== ADMIN ==================== */
function renderAdmin(){
  renderMasterList('models','modelList','modelCount');
  renderMasterList('partNos','partNoList','partNoCount');
  renderMasterList('assemblies','assemblyList','assemblyCount');
  renderMasterList('variants','variantList','variantCount');
  renderUserList();
}

function renderMasterList(key,listId,countId){
  const ul=document.getElementById(listId);
  if(!ul)return;
  const items=db[key];
  document.getElementById(countId).textContent=items.length;
  if(!items.length){ul.innerHTML='<div class="admin-empty">No items yet.</div>';return;}
  ul.innerHTML=items.map((v,i)=>`<li><span>${v}</span><button class="admin-delete-btn" onclick="removeMaster('${key}',${i},'${listId}','${countId}')" title="Remove">‚úï</button></li>`).join('');
}

function addMaster(key,inputId,listId,countId){
  const inp=document.getElementById(inputId);
  const val=inp.value.trim();
  if(!val){showToast('Enter a value.','error');return;}
  if(db[key].includes(val)){showToast('Already exists!','error');return;}
  db[key].push(val);save(key);inp.value='';
  renderMasterList(key,listId,countId);renderDropdowns();showToast(`"${val}" added!`);
}

function removeMaster(key,idx,listId,countId){
  const val=db[key][idx];
  if(!confirm(`Remove "${val}"?`))return;
  db[key].splice(idx,1);save(key);
  renderMasterList(key,listId,countId);renderDropdowns();showToast(`"${val}" removed.`);
}

function renderUserList(){
  const ul=document.getElementById('userList');
  if(!ul)return;
  document.getElementById('userCountBadge').textContent=db.users.length;
  ul.innerHTML=db.users.map(u=>`<li>
    <span style="color:var(--text)">${u.username}</span>
    <span style="color:${u.role==='admin'?'var(--accent)':'var(--accent3)'};font-size:.65rem;letter-spacing:1px;text-transform:uppercase;margin:0 auto 0 10px;">${u.role}</span>
    ${u.username!=='admin'?`<button class="admin-delete-btn" onclick="removeUser(${u.id})">‚úï</button>`:'<span style="font-size:.65rem;color:var(--muted)">Protected</span>'}
  </li>`).join('');
}

function addUser(){
  const u=document.getElementById('newUserName').value.trim();
  const p=document.getElementById('newUserPass').value;
  const r=document.getElementById('newUserRole').value;
  if(!u||!p){showToast('Username and password required.','error');return;}
  if(db.users.find(x=>x.username===u)){showToast('Username exists!','error');return;}
  db.users.push({id:Date.now(),username:u,password:p,role:r,added:new Date().toLocaleDateString()});
  save('users');
  document.getElementById('newUserName').value='';
  document.getElementById('newUserPass').value='';
  renderUserList();showToast(`User "${u}" added!`);
}

function removeUser(id){
  const user=db.users.find(u=>u.id===id);if(!user)return;
  if(user.username==='admin'){showToast('Cannot delete default admin!','error');return;}
  if(!confirm(`Delete "${user.username}"?`))return;
  db.users=db.users.filter(u=>u.id!==id);save('users');renderUserList();showToast('User removed.');
}

/* ==================== UTILS ==================== */
function showToast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast'+(type?' '+type:'');
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);
}
function updateClock(){
  document.getElementById('clockDisplay').textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
updateClock();setInterval(updateClock,1000);
window.addEventListener('resize',()=>{if(document.getElementById('appPage').classList.contains('active'))renderCharts();});
</script>
</body>
</html>
